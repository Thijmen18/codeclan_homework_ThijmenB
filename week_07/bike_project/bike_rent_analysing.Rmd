---
title: "R Notebook"
output: html_notebook
---


```{r}
#open packages
library(tidyverse)
library(tsibble)
library(tsibbledata)
library(skimr)
library(lubridate)
library(ggplot2)
```

```{r}
# explore data
nyc_bikes <- nyc_bikes

head(nyc_bikes)
glimpse(nyc_bikes)
skim(nyc_bikes)
```

```{r}
# Let's prepare/wrangle/clean the data for the visualisations

## lets get separate columns for year, month, day of bike rent:
nyc_bikes_dates <- nyc_bikes %>% 
  mutate(year = year(start_time),
         month = month(start_time, label = TRUE, abbr = TRUE),
         day = day(start_time),
         weekday = wday(start_time, label = TRUE, abbr = TRUE))
 
  

nyc_bikes_dates

```

---------------------------------------
Step 1
# -> visualisations of bike rentals per set time period:

```{r}
# Check nr of bike rentals per set time period:

# Year

nyc_bikes_dates %>% 
  index_by(year) %>% 
  summarise(rental_per_year = n())
  
# Year = 2018, total bike hires = 4268
  
```

```{r}
# month

nyc_bikes_dates %>% 
  index_by(month) %>% 
  summarise(rental_per_month = n()) %>% 
  ggplot() +
  aes(x = month, y = rental_per_month) +
  geom_col()

```
total_rental_month_plot
-> This bar plot shows the number of bike hires per month in 2018. We can see that 
    bike hires peak in August with over 700 bike hires, while the lowest number of bikes
    are rented in February with just over 100 bike hires.
-> For the bike rental company it is important to know which month's are least popular 
    for bike rentals because the commercial/advertisement team could focus on the least 
    popular months to attract more customers.
    Further, the customer team can focus on the most busy months in terms of improving customer
    experience in successful months in order not to loose customers due to heavy demands.

```{r}
# per season

# lets check per season, with (Dec, Jan, Feb = Winter); (Mar, Apr, May = Spring); (Jun, Jul, Aug = Summer); (Sep, Okt, Nov: Autumn) 
nyc_bikes_dates %>% 
  mutate(season = recode(month,
                        "Jan" = "Winter",
                        "Feb" = "Winter",
                        "Mar" = "Spring",
                        "Apr" = "Spring",
                        "May" = "Spring",
                        "Jun" = "Summer",
                        "Jul" = "Summer",
                        "Aug" = "Summer",
                        "Sep" = "Autumn",
                        "Oct" = "Autumn",
                        "Nov" = "Autumn",
                        "Dec" = "Winter")) %>% 
  index_by(season) %>% 
  summarise(rental_per_season = n()) %>% 
  ggplot() +
  aes(x = season, y = rental_per_season) +
  geom_col()
```
total_rental_season_plot
-> This bar plot shows the number of bike hires per season in 2018. We can see that 
    bike hires peak during the Summer with over 1750 bike hires, while the lowest number of bikes
    are rented in Winter with less than 500 bike hires.
-> For the bike rental company it is important to know which seasons are least popular 
    for bike rentals because the commercial/advertisement team could focus on the least 
    popular seasons to attract more customers.
->  For example: it could be that in seasons with nice weather rental numbers peak. 
    However, in Spring we generally see better weather than Autumn and still rental 
    numbers in Spring are second lowest.
    This could be a great opportunity for the advertisement team to focus on!
    
```{r}
# per quarter


nyc_bikes_dates %>% 
  mutate(quarter = recode(month,
                        "Jan" = "Q1",
                        "Feb" = "Q1",
                        "Mar" = "Q1",
                        "Apr" = "Q2",
                        "May" = "Q2",
                        "Jun" = "Q2",
                        "Jul" = "Q3",
                        "Aug" = "Q3",
                        "Sep" = "Q3",
                        "Oct" = "Q4",
                        "Nov" = "Q4",
                        "Dec" = "Q4")) %>% 
  index_by(quarter) %>% 
  summarise(rental_per_quarter = n()) %>% 
  ggplot() +
  aes(x = quarter, y = rental_per_quarter) +
  geom_col()
```
total_rental_quarter_plot
-> This bar plot shows the number of bike hires per quarter in 2018. We can see that 
    bike hires peak during Q3 with over 1750 bike hires, while the lowest number of bikes
    are rented in Q1 with less than 500 bike hires.
-> This is useful information for the financial teams, as budgets are generally 
   created per quarter. However to get insight in customer behaviour it is more interesting
   to look at seasonal changes, since there is one important difference between this graph
   and the seasonal graph: Q2 does include June and excludes March which potentially 
   highlights the importance of weather/climate for rental numbers!
   
```{r}
# weekdays
nyc_bikes_dates %>% 
  index_by(weekday) %>% 
  summarise(rental_per_weekday = n()) %>% 
  ggplot() +
  aes(x = weekday, y = rental_per_weekday) +
  geom_col()

#days (not of interest!)
#nyc_bikes_dates %>% 
#  index_by(day) %>% 
#  summarise(rental_per_day = n()) %>% 
#  ggplot() +
#  aes(x = day, y = rental_per_day) +
#  geom_col()
```
total_rental_weekday_plot
-> This bar plot shows the total number of bike hires per weekday in 2018. We can see that 
    bike hires are most popular on Tuesdays with over 700 bike hires, while the lowest number of bikes
    are rented on Sundays with ~450 bike hires.
-> For the bike rental company it is important to know which day's are least popular 
    for bike rentals because the commercial/advertisement team could focus on the least 
    popular days to attract more customers.
    Interestingly, most popular day to rent a bike is on a weekday while the least popular 
    day is a day in the weekend! A great focus could be to advertise sightseeing trips
    per bikes on sundays.
    
    
```{r}
#moments on the day, people take bikes

nyc_bikes_dates %>% 
  mutate(hour = hour(start_time)) %>% 
  ggplot() +
  aes(x = hour) +
  geom_bar() +
  facet_wrap(~weekday)

```
total_rental_weekday_perhour_plot
-> This bar plot shows the total number of bike hires per weekday split per start 
    time (in hours). We can see that 
    bike hires are most popular during rush hour on weekdays. While Saturday and 
    Sunday show a more equal popularity of bikes.
-> For the bike rental company it is important to know which hours of the day bikes 
    are most popular to rent. For the operational team it is importance to haev as much 
    bikes available as possible during rush hours. But for the advertisement team
    it is important to realise that it might be smart to focus on tourists during the day
    to increase hires.

---------------------------------------
Step 2
# -> visualisations of bike rentals per demographic:

=====
-> look at gender and lets focus now on day and season:
```{r}
# gender
nyc_bikes_dates %>% 
  ggplot() +
  aes(x = weekday) +
  geom_bar() +
  facet_wrap(~ gender)
```
total_rental_weekday_per_gender_plot
-> This bar plot shows the total number of bike hires per weekday in 2018, divided 
    per gender. We can see that bike hires are most popular among males than females.
    For females there is hardly a difference in bike rentals between days.
    Bike hires are (mostly) more than double as popular to rent by males than females.
    With most popular day for a bike rent being Tuesday, and least popular being Sunday. 
-> Populaity of bike hire difference between gender is valuable for the rental company 
  to know as the commercial/advertisement team could focus on the females to make bike
  renting more popular among females.
  
  Important here is to send the information also to the customer team, to further
  investigate this difference. 
  The underlying cause can namely be that females feel unsafe renting a bike, this \
  needs to be investigated further!
  
```{r}
nyc_bikes_dates %>% 
  mutate(season = recode(month,
                        "Jan" = "Winter",
                        "Feb" = "Winter",
                        "Mar" = "Spring",
                        "Apr" = "Spring",
                        "May" = "Spring",
                        "Jun" = "Summer",
                        "Jul" = "Summer",
                        "Aug" = "Summer",
                        "Sep" = "Autumn",
                        "Oct" = "Autumn",
                        "Nov" = "Autumn",
                        "Dec" = "Winter")) %>% 
  ggplot() +
  aes(x = season) +
  geom_bar() +
  facet_wrap(~ gender)
```
We see the same difference when looking at the data per season.

=======
AGE
-> look at age and lets focus now on day and season:
```{r}
# let's add age to the dataset, and divide per age group
  # 0-17, 18-25, 26-35, 35-50, 50-65, 66-up
nyc_bikes_dates_age <- nyc_bikes_dates %>% 
    mutate(age = 2018 - birth_year) %>% 
  mutate(age_group = case_when(
    age < 18 ~ "0-17",
    age >= 18 & age <= 25 ~ "18-25",
    age > 25 & age <= 35 ~ "26-35",
    age > 35 & age <= 50 ~ "36-50",
    age > 50 & age <= 65 ~ "50-65",
    age > 65 ~ "66-up"
  ))
  
#age group for separate days
nyc_bikes_dates_age %>% 
  ggplot() +
  aes(x = weekday) +
  geom_bar() +
  facet_wrap(~ age_group)

```

total_rental_weekday_per_agegroup_plot
-> This bar plot shows the total number of bike hires per weekday in 2018, divided 
    per age-group. We can see that bike hires are most popular among young adult, 
    followed by late-30s/40s group. Bike renting is less popular among young adults, 
    and older generations (50+).
    Weekday popularity is roughly similar among the groups.
-> Populaity of bike hire difference between age groups is valuable for the rental company 
  to know as the commercial/advertisement team could focus on either the young adult
  generation and/or older generations in order to increase popularity and increase $ revenue! 
  
```{r}
# lets divide per age-group and season

nyc_bikes_dates_age %>% 
  mutate(season = recode(month,
                        "Jan" = "Winter",
                        "Feb" = "Winter",
                        "Mar" = "Spring",
                        "Apr" = "Spring",
                        "May" = "Spring",
                        "Jun" = "Summer",
                        "Jul" = "Summer",
                        "Aug" = "Summer",
                        "Sep" = "Autumn",
                        "Oct" = "Autumn",
                        "Nov" = "Autumn",
                        "Dec" = "Winter")) %>% 
  ggplot() +
  aes(x = season) +
  geom_bar() +
  facet_wrap(~ age_group)
```
We see the same difference when looking at the data per season.

=======
AGE & gender

```{r}
nyc_bikes_dates_age %>% 
  ggplot() +
  aes(x = weekday) +
  geom_bar() +
  facet_grid(gender ~ age_group)
```


=======
Type of trip

```{r}
nyc_bikes_dates_age %>% 
  ggplot() +
  aes(x = weekday) +
  geom_bar() +
  facet_wrap(~ type)
```
total_rental_weekday_per_type_plot
-> This bar plot shows the total number of bike hires per weekday in 2018, divided 
    per trip type. We can see that bike hires are most popular among subscribers than customers.
    With on Monday-Friday a difference of almost 6x! 
-> Populaity of bike hire difference between trip type is valuable for the rental company 
  to know as the commercial/advertisement team could focus on getting more customers
  changed into active subscribers!
  
Step 3
# -> visualisations of total bike rentals for 2018:

```{r}
nyc_bikes_dates_age %>%
  arrange(start_time) %>% 
  mutate(trip_accumulative = row_number()) %>% 
  ggplot() +
  aes(x = start_time, y = trip_accumulative, group = ) +
  geom_line()
```

# -> trip times

```{r}
#trip times below 1 hour

nyc_bikes_dates_age %>%
  mutate(trip_time = stop_time - start_time) %>% 
  mutate(time_hours = as.numeric(trip_time, "hours")) %>% 
  filter(time_hours <= 1) %>% 
  ggplot() +
  aes(x = time_hours) +
  geom_histogram(col = "white")

# trip times above 1 hour

nyc_bikes_dates_age %>%
  mutate(trip_time = stop_time - start_time) %>% 
  mutate(time_hours = as.numeric(trip_time, "hours")) %>% 
  filter(time_hours >= 1) %>% 
  ggplot() +
  aes(x = time_hours) +
  geom_histogram(col = "white", bins = 60)

```

# -> two variables

```{r}
nyc_bikes_dates_age %>%
  mutate(trip_time = stop_time - start_time) %>% 
  mutate(time_hours = as.numeric(trip_time, "hours")) %>% 
  filter(time_hours <= 1) %>% 
  filter(age < 75) %>% 
  ggplot() +
  aes(x = time_hours, y = age) +
  geom_point()


nyc_bikes_dates_age %>%
  mutate(trip_time = stop_time - start_time) %>% 
  mutate(time_hours = as.numeric(trip_time, "hours")) %>% 
  filter(time_hours <= 1) %>% 
  filter(age < 75) %>% 
  ggplot() +
  aes(x = time_hours, y = age) +
  geom_point()
```

==================
Additional business questions

Spatial data analyses

Q: What is the geographical spread of the start points of bike hires?
```{r}
library(sf)
library(tidyverse)
library(leaflet)
```

```{r}
# Lets create a map with the geographical spread of start points of bike hires:

leaflet(nyc_bikes) %>% 
  addTiles() %>% 
  addCircleMarkers(
    lng = ~ start_long,
    lat = ~ start_lat,
    clusterOptions = markerClusterOptions()
  )

```
Based on this geographical plot we see the number of bike rental starting points
as plotted on the map of NYC.
We clearly see that the most bike hires started in Jersey City, with the highest number of 
bike hires on Christopher Columbus Drive station.

-> This is important for the planning/operational team to know because they can 
increase the focus of their work in Jersey City area to make sure there are enough
bike hires at peak times of the day.
-> In areas around Jersey city, we see that bike hires are much lower. This is important
for the advertisement team to know, as they can increase visibility of the service
provided in these ares in order to attract more customers.

-----
!!!
-> Lets create a map of all end stations for hired bikes

```{r}
# Lets create a map with the geographical spread of end points of bike hires:

leaflet(nyc_bikes) %>% 
  addTiles() %>% 
  addCircleMarkers(
    lng = ~ end_long,
    lat = ~ end_lat,
    clusterOptions = markerClusterOptions()
  )

```

Again we see that the most popular station is Jersey City, and eventhough most bikes
are returned within the greater Jersey City area we also see some individual bikes 
being returned at a greater distance including Greenvile and Manhatten island. 

-> This is important for the company as it demonstrates that there is an interest in 
returning bikes at a further distance from the start point. For the advertisement 
team this is interesting as it may be of interest to focus on customers that want to travel 
longer distances.\

---
  !!!
-> let's map all end stations, of all trips longer than 30 mins
```{r}

nyc_bikes %>% 
  mutate(trip_time = stop_time - start_time) %>% 
  mutate(time_hours = as.numeric(trip_time, "hours")) %>% 
  filter(time_hours >= 1) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(
    lng = ~ end_long,
    lat = ~ end_lat,
    clusterOptions = markerClusterOptions()
  )
```
And indeed, if we only include trips longer than 1 hour, we see that most bikes are 
still returned in and around Jersey City but also on Manhatten Island
-> Interesting to explore if there could be a new customer base!

---
!!!
Can you predict bike use over the next couple of months? (This is based on the 
flipped time series forecasting lesson)

```{r}
library(fable)
library(urca)
library(tsibble)

# lets create/clean the data by downsampling and summarising bike hires per month
# select the variables we need:
bike_hires_per_month <-  nyc_bikes_dates %>% 
  index_by(month) %>% 
  summarise(rentals_per_month = n())

# Use autoplot to check the series:
bike_hires_per_month %>% 
  mutate(sum = cumsum(rentals_per_month)) %>% 
  select(month, sum) %>% 
  ggplot() +
  aes(x = month, y = sum) +
  geom_line()



```